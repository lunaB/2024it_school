<!DOCTYPE html>
<html data-theme="light">

<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hello Bulma!</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="common.js"></script>
  <script src="game.js"></script>
  <style>
    .ptr {
      cursor: pointer;
      transition: 0.4s all ease;
    }

    .ptr:hover {
      background-color: rgba(0, 0, 0, 0.1);
    }

    .table-container {
      margin: 20px;
      overflow: auto;
    }

    th {
      background-color: #00d1b2;
      color: white;
    }

    td {
      vertical-align: middle;
    }

    .fish-image {
      width: 50px;
      height: auto;
      border-radius: 5px;
    }

    .button.is-danger {
      margin-left: 10px;
    }

    th {
      background-color: #00d1b2;
      color: white;
    }

    td {
      vertical-align: middle;
    }

    .fish-image {
      width: 50px;
      height: auto;
      border-radius: 5px;
    }

    .button.is-danger {
      margin-left: 10px;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="container">
      <nav class="navbar" role="navigation" aria-label="main navigation"
        style="border-bottom: 1px solid rgba(0, 0, 0, 0.1)">
        <div class="navbar-brand">
          <a class="navbar-item" href="https://bulma.io">
            <svg width="640" height="160" viewBox="0 0 640 160" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M170 132.571V27.5908C170 25.5451 170.915 23.93 172.746 22.7456C174.576 21.5612 176.729 20.969 179.206 20.969H210.377C232.019 20.969 242.84 30.4441 242.84 49.3943C242.84 62.5303 238.264 71.0902 229.112 75.074C234.603 77.2275 238.748 80.2692 241.548 84.1992C244.347 88.1292 245.747 93.8627 245.747 101.4V104.791C245.747 116.743 242.84 125.437 237.026 130.875C231.211 136.312 223.351 139.031 213.445 139.031H179.206C176.514 139.031 174.307 138.385 172.584 137.093C170.861 135.801 170 134.293 170 132.571ZM190.834 120.619H209.085C219.529 120.619 224.751 114.751 224.751 103.015V100.431C224.751 94.401 223.432 90.0404 220.794 87.3486C218.156 84.6568 214.253 83.3109 209.085 83.3109H190.834V120.619ZM190.834 66.8371H208.923C213.122 66.8371 216.326 65.5989 218.533 63.1225C220.74 60.646 221.844 57.2544 221.844 52.9475C221.844 48.7483 220.686 45.4374 218.371 43.0148C216.057 40.5922 212.853 39.3809 208.762 39.3809H190.834V66.8371ZM260.283 103.015V27.4293C260.283 25.2759 261.306 23.6608 263.351 22.5841C265.397 21.5074 267.873 20.969 270.781 20.969C273.688 20.969 276.164 21.5074 278.21 22.5841C280.256 23.6608 281.279 25.2759 281.279 27.4293V103.015C281.279 115.397 287.2 121.588 299.044 121.588C310.888 121.588 316.81 115.397 316.81 103.015V27.4293C316.81 25.2759 317.833 23.6608 319.879 22.5841C321.925 21.5074 324.401 20.969 327.308 20.969C330.215 20.969 332.692 21.5074 334.738 22.5841C336.783 23.6608 337.806 25.2759 337.806 27.4293V103.015C337.806 115.72 334.28 125.061 327.227 131.036C320.175 137.012 310.781 140 299.044 140C287.308 140 277.914 137.039 270.861 131.117C263.809 125.195 260.283 115.828 260.283 103.015ZM356.703 132.409V27.4293C356.703 25.2759 357.725 23.6608 359.771 22.5841C361.817 21.5074 364.293 20.969 367.201 20.969C370.108 20.969 372.584 21.5074 374.63 22.5841C376.676 23.6608 377.699 25.2759 377.699 27.4293V120.619H417.106C419.044 120.619 420.579 121.534 421.709 123.365C422.84 125.195 423.405 127.349 423.405 129.825C423.405 132.301 422.84 134.455 421.709 136.285C420.579 138.116 419.044 139.031 417.106 139.031H365.908C363.432 139.031 361.279 138.439 359.448 137.254C357.618 136.07 356.703 134.455 356.703 132.409ZM434.872 132.409V31.467C434.872 27.9138 435.868 25.2759 437.86 23.5532C439.852 21.8304 442.355 20.969 445.37 20.969C449.354 20.969 452.423 21.6689 454.576 23.0686C456.729 24.4684 459.098 27.4832 461.682 32.1131L481.548 68.2907L501.413 32.1131C503.997 27.4832 506.393 24.4684 508.6 23.0686C510.808 21.6689 513.903 20.969 517.887 20.969C520.902 20.969 523.405 21.8304 525.397 23.5532C527.389 25.2759 528.385 27.9138 528.385 31.467V132.409C528.385 134.455 527.335 136.07 525.236 137.254C523.136 138.439 520.686 139.031 517.887 139.031C514.98 139.031 512.503 138.439 510.458 137.254C508.412 136.07 507.389 134.455 507.389 132.409V62.961L488.493 96.5545C486.985 99.354 484.616 100.754 481.386 100.754C478.264 100.754 475.949 99.354 474.441 96.5545L455.868 61.6689V132.409C455.868 134.455 454.818 136.07 452.719 137.254C450.619 138.439 448.17 139.031 445.37 139.031C442.463 139.031 439.987 138.439 437.941 137.254C435.895 136.07 434.872 134.455 434.872 132.409ZM539.529 130.31C539.529 130.094 539.637 129.556 539.852 128.694L571.023 27.1063C571.669 24.8452 573.257 23.0956 575.787 21.8573C578.318 20.6191 581.198 20 584.428 20C587.658 20 590.565 20.6191 593.149 21.8573C595.734 23.0956 597.349 24.8452 597.995 27.1063L629.166 128.694C629.381 129.556 629.489 130.094 629.489 130.31C629.489 132.678 628.035 134.724 625.128 136.447C622.221 138.17 619.26 139.031 616.245 139.031C612.261 139.031 609.892 137.631 609.139 134.832L603.001 113.351H566.016L559.879 134.832C559.125 137.631 556.756 139.031 552.773 139.031C549.65 139.031 546.662 138.197 543.809 136.528C540.956 134.859 539.529 132.786 539.529 130.31ZM570.377 96.8775H598.479L584.428 47.2948L570.377 96.8775Z"
                fill="black" class="bd-svg-black" />
              <path fill-rule="evenodd" clip-rule="evenodd" d="M0 110L10 40L50 0L100 50L70 80L110 120L50 160L0 110Z"
                fill="#00D1B2" />
            </svg>
          </a>

          <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false"
            data-target="navbarBasicExample">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
          </a>
        </div>

        <div id="navbarBasicExample" class="navbar-menu">
          <div class="navbar-start">
            <a class="navbar-item" href="index.html">
              메인 페이지
            </a>

            <a class="navbar-item" href="aboutus.html">
              프로젝트 소개
            </a>
          </div>

          <div class="navbar-end">
            <div class="navbar-item">
              <div class="buttons">
                <a class="button is-primary" href="register.html">
                  <strong>회원가입</strong>
                </a>
                <a class="button is-light" href="login.html">
                  로그인
                </a>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </div>
    <section class="hero is-fullheight-with-navbar">
      <div class="hero-body">
        <div class="container has-text-centered">
          <div class="box" style="height: 800px; position: relative;">
            <!-- GAME Component -->


            <!-- Player -->
            <div style="position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);">
              <div>
                <img :src="`resource/cats/${cat}.png`" alt="">
              </div>
            </div>

            <!-- Loading -->
            <div style="position: absolute; top: 10%; left: 50%; transform: translate(-50%, -50%);">
              <div class="box" style="width: 300px; margin:0 auto;">
                <p class="subtitle">낚시 시작!</p>
                <progress class="progress is-primary" value="0" max="100">50%</progress>
              </div>
            </div>

            <!-- money -->
            <div class="myMoney" style="text-align: right;">
              <p class="price" style="font-size: 20px; font-weight: 900;">보유 머니: <span
                  style="font-weight: 100;">{{moeny}}</span>원</p>
            </div>

            <!-- Navigator -->
            <div style="position: absolute; bottom:0; left:0">
              <div class="box">
                <div class="columns is-multiline">
                  <div class="column is-6">
                    <div class="box ptr" @click="showInventory">
                      <p class="title is-6">인벤토리</p>
                    </div>
                  </div>
                  <div class="column is-6">
                    <div class="box ptr" @click="showFishShop">
                      <p class="title is-6">물고기 장터</p>
                    </div>
                  </div>
                  <div class="column is-6">
                    <div class="box ptr" @click="showShop">
                      <p class="title is-6">아이템 상점</p>
                    </div>
                  </div>
                  <div class="column is-6">
                    <div class="box ptr" id="game-start-button">
                      <p class="title is-6">낚시 하기</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Inventory -->
            <div id="inventory" style="position: absolute; top: 0%; left: 0%; display:none;">
              <div class="box" style="width:1345px; height: 800px;">
                <div class="box_header" style="position: relative; ">
                  <p class="title is-2" style="padding: 15px 0;">인벤토리</p>
                  <button class="button is-danger is-outlined" style="position: absolute; top: 0; left: 1190px;"
                    @click="exitInventory">Close X</button>
                </div>
                <div class="columns is-multiline" style="max-height: 680px; overflow-y: scroll;">
                  <template v-for="item in items" :key="item.name">
                    <div class="column is-3"
                      v-if="item.type == 'food'  && item.quantity > 0 || item.type=='fish' && item.quantity > 0 ">
                      <!-- 음식 및 물고기 -->
                      <div class="card">
                        <div class="card-image">
                          <figure class="image is-4by3" style="border-bottom: 1px solid #ddd;">
                            <img src="./resource/cat.png" alt="Placeholder image" />
                          </figure>
                        </div>
                        <div class="card-content">
                          <div class="media">
                            <div class="media-left" style="width: 125px;">
                              <p class="title is-5" style="align-items: center; align-content: center;">{{item.name}}
                              </p>
                            </div>
                            <div class="media-content" style="width: 125px;">
                              <p class="title is-6">수량 : {{item.quantity}}</p>
                              <p class="subtitle is-7 mt-2">{{item.desc}}</p>
                              <button v-if="item.type == 'food'" class="button is-primary">먹기</button>
                              <button v-else></button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="column is-3" v-else-if="item.type == 'fishing_rod' && item.durability > 0 ">
                      <!-- 낚시대 -->
                      <div class="card">
                        <div class="card-image">
                          <figure class="image is-4by3" style="border-bottom: 1px solid #ddd;">
                            <img src="./resource/cat.png" alt="Placeholder image" />
                          </figure>
                        </div>
                        <div class="card-content">
                          <div class="media" style="height: 80px;">
                            <div class="media-left" style="width: 125px;">
                              <p class="title is-5" style="align-items: center; align-content: center;">{{item.name}}
                              </p>
                            </div>
                            <div class="media-content" style="width: 125px;">
                              <p class="title is-6">내구도 : {{item.durability}}</p>
                              <p class="subtitle is-7">수심 : {{item.grade}}</p>
                              <button class="button is-primary" v-if="item.equipped > 0" onclick="">장착중</button>
                              <div class="button is-primary" v-else @click="equipFishingRod">장착하기</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <!-- GAME Component -->
            <div id="game"
              style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display:none;">
              <p class="title">방향키를 순서대로 누르세요!</p>
              <div id="current-key"></div>
              <button id="close-game-button"
                style="position: absolute; top: -50px; right: 10px;transform: translate(-50%, -50%); padding: 5px 10px; cursor: pointer;">
                게임 종료
              </button>
              <div class="" style="margin-top: 10px;"></div>
            </div>

            <!--  -->
            <div class="modal" id="item-modal">
              <div class="modal-background"></div>
              <div class="modal-content" style="width: 1300px; margin-top: 10%; max-height: 600px; overflow-y: auto;">
                <div class="box">
                  <h1 class="title">낚시 아이템 상점</h1>
                  <div class="columns is-multiline" style="width: 1200px; margin: 0 auto;">
                    <div class="column is-one-third" v-for="item in shop" :key="item.name">
                      <div class="card">
                        <div class="card-content" style="width: 400px;">
                          <p class="title">{{item.name}}</p>
                          <p class="subtitle" style="margin: 10px 0;">수심: {{item.desc}}</p>
                          <p class="subtitle" style="margin: 10px 0;">내구도: {{item.durability}}</p>
                          <p class="subtitle" style="margin: 10px 0;">가격: {{item.price}} 원</p>
                          <button class="button is-success" v-on:click="buyItem(item)">구매</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <h1 class="title mt-6">음식 상점</h1>
                  <div class="columns is-multiline" style="width: 1200px; margin: 0 auto;">
                    <div class="column is-one-third" v-for="item in food" :key="item.name">
                      <div class="card">
                        <div class="card-content" style="width: 400px;">
                          <p class="title">{{item.name}}</p>
                          <p class="subtitle" style="margin: 10px 0;">포만감: {{item.saturation}}</p>
                          <p class="subtitle" style="margin: 10px 0;">가격: {{item.price}} 원</p>
                          <button class="button is-success" v-on:click="buyItem(item)">구매</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <button class="modal-close is-large" aria-label="close" @click="exitShop"></button>
            </div>

            <!--  -->
            <div class="modal" id="fish-modal">
              <div class="modal-background"></div>
              <div class="modal-card" style="width: 1300px; margin: 0 auto;">
                <div class="table-container">
                  <table class="table is-bordered is-striped is-hoverable is-fullwidth"
                    style="margin-top: 100px; height: 800px;">
                    <thead>
                      <tr>
                        <th>이미지</th>
                        <th>물고기 이름</th>
                        <th>가격</th>
                        <th>보유 수량</th>
                        <th>판매 수량</th>
                        <th>매도 버튼</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td><img src="https://via.placeholder.com/50" alt="물고기 이미지" class="fish-image"></td>
                        <td>고등어</td>
                        <td>10,000원</td>
                        <td>5</td>
                        <td><input type="number" class="input is-small" placeholder="판매 수량"></td>
                        <td><button class="button is-danger is-small">Sell</button></td>
                      </tr>
                      <tr>
                        <td><img src="https://via.placeholder.com/50" alt="물고기 이미지" class="fish-image"></td>
                        <td>참치</td>
                        <td>25,000원</td>
                        <td>2</td>
                        <td><input type="number" class="input is-small" placeholder="판매 수량"></td>
                        <td><button class="button is-danger is-small">Sell</button></td>
                      </tr>
                    </tbody>
                  </table>
                  <button class="modal-close is-large" aria-label="close" @click="exitFishShop"></button>
                </div>

              </div>
            </div>
          </div>
        </div>
    </section>
  </div>
  <script type="module">
    import { createApp, ref } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

    const app = createApp({
      data() {
        return {
          host: "http://192.168.202.21",
          port: "8080",
          moeny: 10000,
          cat: "fishing1",
          items: [
            { name: '비트참치', desc: '매우 값비싼 비트참치', "type": '', quantity: 1 },
          ],
          shop: [
            { name: '중국산 대나무 낚싯대', desc: 'shallow', durability: '40', price: '8,900' },
            { name: '독일산 목재 낚싯간', desc: 'shallow', durability: '150', price: '20,000' },
            { name: '중국산 탄소섬유 낚싯대', desc: 'thermocline', durability: '90', price: '69,990' },
            { name: '독일산 카본 낚싯대', desc: 'thermocline', durability: '200', price: '118,000' },
            { name: '중국산 유리섬유 낚싯대', desc: 'deep', durability: '100', price: '191,950' },
            { name: '독일산 글라스 낚싯대', desc: 'deep', durability: '250', price: '383,900' },
          ],
          food: [
            { name: '회 한 점', saturation: 5, price: 550 },
            { name: '꽁치 통조림', saturation: 10, price: 1000 },
            { name: '참치 초밥', saturation: 15, price: 1500 },
            { name: '붕어빵 프레스티지', saturation: 20, price: 1850 },
            { name: '해파리냉채', saturation: 25, price: 2320 },
            { name: '전어구이', saturation: 30, price: 2890 },
            { name: '똠양꿍', saturation: 35, price: 3290 },
            { name: '만두', saturation: 40, price: 3600 },
            { name: '월병', saturation: 45, price: 400 },
            { name: '탕후루', saturation: 50, price: 4250 },
            { name: '마라탕', saturation: 55, price: 4700 },
          ]
        }
      },

      methods: {
        // 인벤토리
        showInventory() {
          document.getElementById('inventory').style.display = 'block'
          this.inventory()
        },
        exitInventory() {
          document.getElementById('inventory').style.display = "none";
        },

        // 물고기 장터  
        showFishShop() {
          document.querySelector('#fish-modal').style.display = "block"
        },
        exitFishShop() {
          document.querySelector('#fish-modal').style.display = "none"
        },

        // 아이템 상점
        showShop() {
          document.querySelector('#item-modal').style.display = "block"
        },
        exitShop() {
          document.querySelector('#item-modal').style.display = "none"
        },

        

        // 낚시 하기
        fishing() {
          // 1. 방향키를 랜덤으로 생성
          // 2. 방향키를 순서대로 누르게 함
          // 3. 누르는 방향키가 맞으면 성공, 아니면 실패
        },

        // 정보 조회
        loadInfo() {
          // 유저의 모든 변경사항 업데이트
        },

        // 인벤토리 조회
        // POST /v1/game/inventory
        inventory() {
          console.log(2)
          // 유저의 인벤토리 조회
          const username = sessionStorage.getItem('username');
          $.ajax({
            url: this.host + ":" + this.port + '/v1/game/inventory',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            data: JSON.stringify({ username: username }),
            success: (response) => {
              if (response.success) {
                console.log(response)

                this.items = response.items;
              } else {
                console.error('Failed to fetch inventory');
              }

            },
            error: (error) => {
              console.error('Error fetching inventory:', error);
            }
          });
        },




        // 낚시대 장착
        // POST /v1/game/fishing_rod
        equipFishingRod(fishingRodName) {
          username = sessionStorage.getItem('username');

          $.ajax({
            url: this.host + ":" + this.port + '/v1/game/fishing_rod',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            data: JSON.stringify({ username: username, fishing_rod: fishingRodName }),
            success: (response) => {
              console.log(response);
              
              if (response.success) {
                console.log('Fishing rod equipped successfully');
              } else {
                console.error('Failed to equip fishing rod');
              }
            },
            error: (error) => {
              console.error('Error equipping fishing rod:', error);
            }
          });
        },

        // 아이템 구매
        // POST /v1/market/item/buy
        buyItem(item) {
          const username = sessionStorage.getItem('username');
          const myMoney = document.querySelector('.myMoney span').textContent;

          console.log(item);
          console.log(myMoney);

          if (myMoney < item.price) {
            alert('돈이 부족합니다.')
          } else {
            alert('구매 완료')
            myMoney += item.price

          }

          $.ajax({
            url: this.host + ":" + this.port + '/v1/market/item/buy',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            data: JSON.stringify({ username: username, market_item: itemName }),
            success: (response) => {
              if (response.success) {
                console.log('Item bought successfully');
              } else {
                console.error('Failed to buy item');
              }
            },
            error: (error) => {
              console.error('Error buying item:', error);
            }
          });
        },

        // 물고기 판매
        sellFish(fishName, quantity) {
          const username = sessionStorage.getItem('username');

          $.ajax({
            url: this.host + ":" + this.port + '/v1/market/fish/sell',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            data: JSON.stringify({ username: username, fish_name: fishName, quantity: quantity }),
            success: (response) => {
              if (response.success) {
                console.log('Fish sold successfully');
              } else {
                console.error('Failed to sell fish');
              }
            },
            error: (error) => {
              console.error('Error selling fish:', error);
            }
          });
        },

        // 음식 먹기
        eatFood(foodName) {
          const username = sessionStorage.getItem('username');

          $.ajax({
            url: this.host + ":" + this.port + '/v1/food',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            data: JSON.stringify({ username: username, food_name: foodName }),
            success: (response) => {
              if (response.success) {
                console.log('Food eaten successfully');
              } else {
                console.error('Failed to eat food');
              }
            },
            error: (error) => {
              console.error('Error eating food:', error);
            }
          });
        },

        // 게임 데이터 로드
        loadGameData() {
          const username = sessionStorage.getItem('username');

          $.ajax({
            url: this.host + ":" + this.port + '/v1/game/load',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            data: JSON.stringify({ username: username }),
            success: (response) => {
              if (response.success) {
                console.log('Game data loaded successfully');
                // Handle the loaded game data here
              } else {
                console.error('Failed to load game data');
              }
            },
            error: (error) => {
              console.error('Error loading game data:', error);
            }
          });
        },

        // 리더보드 조회
        getLeaderboard() {
          const username = sessionStorage.getItem('username');

          $.ajax({
            url: this.host + ":" + this.port + '/v1/leaderboard',
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            },
            data: JSON.stringify({ username: username }),
            success: (response) => {
              if (response.success) {
                console.log('Leaderboard data fetched successfully');
                // Handle the leaderboard data here
              } else {
                console.error('Failed to fetch leaderboard data');
              }
            },
            error: (error) => {
              console.error('Error fetching leaderboard data:', error);
            }
          });
        },

        // 상점 조회
        getMarket(fishes) {
          const username = sessionStorage.getItem('username');

          $.ajax({
            url: this.host + ":" + this.port + '/v1/market',
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            },
            data: JSON.stringify({ username: username, fishes: fishes }),
            success: (response) => {
              if (response.success) {
                console.log('Market data fetched successfully');
                // Handle the market data here
              } else {
                console.error('Failed to fetch market data');
              }
            },
            error: (error) => {
              console.error('Error fetching market data:', error);
            }
          });
        }
      }
    })
    app.mount('#app')
  </script>
</body>

</html>